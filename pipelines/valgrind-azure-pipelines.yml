trigger:
  branches:
   include:
     - master
  paths:
    include:
      - CIFFCAFFParser/*

pr:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - script: |
              sudo apt-get install build-essential
              sudo apt-get install valgrind
            displayName: Install dependencies
          - script: |
              make
            workingDirectory: $(Build.SourcesDirectory)/CIFFCAFFParser
            displayName: Build
          - script: |
              make check
            workingDirectory: $(Build.SourcesDirectory)/CIFFCAFFParser
            displayName: Valgrind
  - stage: SonarCloud
    jobs:
      - job: SonarCloud
        steps:
          - task: SonarCloudPrepare@1
            inputs:
              SonarCloud: 'sonarCloudParser'
              organization: 'bodnarkevin'
              scannerMode: 'CLI'
              configMode: 'manual'
              cliProjectKey: 'caffly-parser'
              cliSources: '$(Build.SourcesDirectory)/CIFFCAFFParser'
              extraProperties: |
                sonar.cfamily.build-wrapper-output=bw-output
          - script: |
              export SONAR_SCANNER_VERSION=4.4.0.2170
              export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
              curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
              unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
              export PATH=$SONAR_SCANNER_HOME/bin:$PATH
              export SONAR_SCANNER_OPTS="-server"
              
              curl --create-dirs -sSLo $HOME/.sonar/build-wrapper-linux-x86.zip https://sonarcloud.io/static/cpp/build-wrapper-linux-x86.zip
              unzip -o $HOME/.sonar/build-wrapper-linux-x86.zip -d $HOME/.sonar/
              export PATH=$HOME/.sonar/build-wrapper-linux-x86:$PATH

              build-wrapper-linux-x86-64 --out-dir bw-output make
            workingDirectory: $(Build.SourcesDirectory)/CIFFCAFFParser
          - task: SonarCloudAnalyze@1
          - task: SonarCloudPublish@1
            inputs:
              pollingTimeoutSec: '300'
